name: PR Self Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  self-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate PR title contains ISSUE number
        run: |
          if [[ ! "${{ github.event.pull_request.title }}" =~ ISSUE\ [0-9]+ ]]; then
            echo "❌ PR title must contain ISSUE number"
            exit 1
          fi

      - name: Validate labels exist
        run: |
          labels=$(jq -r '.pull_request.labels[].name' <<< '${{ toJson(github.event) }}')

          if ! echo "$labels" | grep -q "ai-ready\|ai-in-progress\|ai-review"; then
            echo "❌ Missing AI workflow label"
            exit 1
          fi

      - name: Detect changed files
        id: changes
        run: |
          git fetch origin ${{ github.base_ref }}
          files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "Changed files:"
          echo "$files"

      - name: i18n JSON isolation check
        run: |
          files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          if echo "$files" | grep -q "de.json\|en.json"; then
            if echo "$files" | grep -vq "json$"; then
              echo "❌ i18n JSON rule violated (non-JSON file changed)"
              exit 1
            fi
          fi

      - name: Minimal Diff Check
        run: |
          count=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          if [ "$count" -gt 20 ]; then
            echo "⚠️ Large diff detected. Manual review required."
          fi

      - name: Success
        run: echo "✅ PR Self Check passed"
