name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint_build:
    name: Lint & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install
        run: bun install

      - name: TypeScript Typecheck
        run: bunx tsc --noEmit

      - name: Lint
        run: bun run lint

      - name: Build
        run: bun run build

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint_build
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install
        run: bun install

      - name: Run tests
        run: bun test || echo "No tests found"
        continue-on-error: true

  edge-functions-check:
    name: Edge Functions Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.45.x

      - name: Check Edge Functions Syntax
        run: |
          echo "Checking Edge Functions..."
          for dir in supabase/functions/*/; do
            if [ -f "${dir}index.ts" ]; then
              echo "Checking ${dir}index.ts..."
              deno check --unstable-sloppy-imports "${dir}index.ts" 2>&1 || true
            fi
          done
          echo "Edge Functions check complete"
        continue-on-error: true

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install
        run: bun install

      - name: Run security audit
        run: |
          echo "Running security checks..."
          # Check for known vulnerabilities in dependencies
          bun audit 2>&1 || echo "Audit completed with findings"
        continue-on-error: true
