name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint_build:
    name: Lint & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install
        run: bun install

      - name: TypeScript Typecheck
        run: bunx tsc --noEmit

      - name: Lint
        run: bun run lint

      - name: Build
        run: bun run build

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint_build
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install
        run: bun install

      - name: Run tests
        run: bun test || echo "No tests found"
        continue-on-error: true

  edge-functions-check:
    name: Edge Functions Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.45.x

      - name: Check Edge Functions Syntax
        run: |
          echo "Checking Edge Functions..."
          for dir in supabase/functions/*/; do
            if [ -f "${dir}index.ts" ]; then
              echo "Checking ${dir}index.ts..."
              deno check --unstable-sloppy-imports "${dir}index.ts" 2>&1 || true
            fi
          done
          echo "Edge Functions check complete"
        continue-on-error: true

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install
        run: bun install

      - name: Bun audit (non-blocking, report only)
        run: |
          echo "Running bun audit..."
          bun audit 2>&1 | tee bun-audit.txt || true

      # Add Node/npm only for audit evidence quality
      - name: Setup Node (LTS) for npm audit
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: npm audit (prod only) -> JSON evidence
        run: |
          echo "Running npm audit (prod only)..."
          npm audit --omit=dev --json > npm-audit.json || true
          npm audit --omit=dev 2>&1 | tee npm-audit.txt || true

      - name: Upload audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: |
            bun-audit.txt
            npm-audit.txt
            npm-audit.json

