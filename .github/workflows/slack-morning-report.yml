name: "Morgendlicher Slack Status-Report"

on:
  schedule:
    - cron: '0 6 * * 1-5'
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest
    env:
      SKIP_REPORT: false
      ISSUES_CONTENT: ""
      SPRINT_CONTENT: ""

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Urlaubs-Check
        id: vacation_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Wir fragen die Issues als JSON ab und zÃ¤hlen die EintrÃ¤ge im Array
          PAUSE_COUNT=$(gh issue list --search "Urlaub Pause" --state open --json number --jq 'length')
          
          if [ "$PAUSE_COUNT" -gt 0 ]; then
            echo "SKIP_REPORT=true" >> $GITHUB_ENV
            echo "Urlaubsmodus aktiv ($PAUSE_COUNT Issues gefunden)."
          else
            echo "SKIP_REPORT=false" >> $GITHUB_ENV
            echo "Kein Urlaubssignal gefunden."
          fi

      - name: Daten aus Markdown extrahieren
        if: env.SKIP_REPORT != 'true'
        run: |
          # Extraktion der ersten 20 Zeilen, Backslashes fÃ¼r Slack-JSON maskieren
          ISSUES=$(head -n 20 .ACTIVE_PRIORITY_ISSUES.md | tr -d '\r' | sed 's/"/\\"/g')
          SPRINT=$(head -n 20 .SPRINT_STATUS.md | tr -d '\r' | sed 's/"/\\"/g')
          
          {
            echo "ISSUES_CONTENT<<EOF"
            echo "$ISSUES"
            echo "EOF"
            echo "SPRINT_CONTENT<<EOF"
            echo "$SPRINT"
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Sende Nachricht an Slack Webhook
        if: env.SKIP_REPORT != 'true'
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"â˜• *Guten Morgen! Dein GitHub-Update ist da.*\",
            \"blocks\": [
              {
                \"type\": \"header\",
                \"text\": { \"type\": \"plain_text\", \"text\": \"ðŸš€ Projekt-Status (Mo-Fr)\" }
              },
              {
                \"type\": \"section\",
                \"text\": { \"type\": \"mrkdwn\", \"text\": \"*Aktuelle PrioritÃ¤ten:* \n\`\`\`${{ env.ISSUES_CONTENT }}\`\`\`\" }
              },
              {
                \"type\": \"section\",
                \"text\": { \"type\": \"mrkdwn\", \"text\": \"*Sprint Status:* \n\`\`\`${{ env.SPRINT_CONTENT }}\`\`\`\" }
              }
            ]
          }" ${{ secrets.SLACK_WEBHOOK_URL }}
